angular.module("ui.calendar",[]).constant("uiCalendarConfig",{calendars:{}}).controller("uiCalendarCtrl",["$scope","$locale",function(n,e){var r=n.eventSources,a=n.calendarWatchEvent?n.calendarWatchEvent:angular.noop,t=function(e){return function(){if(n.$root.$$phase)return e.apply(this,arguments);var r=arguments,a=this;return n.$root.$apply(function(){return e.apply(a,r)})}},l=1;this.eventFingerprint=function(n){return n._id||(n._id=l++),""+n._id+(n.id||"")+(n.title||"")+(n.url||"")+(+n.start||"")+(+n.end||"")+(n.allDay||"")+(n.className||"")+a({event:n})||""};var o=1,u=1;this.sourceFingerprint=function(n){var e=""+(n.__id||(n.__id=o++)),r=angular.isObject(n)&&n.events;return r&&(e=e+"-"+(r.__id||(r.__id=u++))),e},this.allEvents=function(){for(var n=[],e=0,a=r.length;e<a;e++){var t=r[e];if(angular.isArray(t))n.push(t);else if(angular.isObject(t)&&angular.isArray(t.events)){var l={};for(var o in t)"_id"!==o&&"events"!==o&&(l[o]=t[o]);for(var u=0;u<t.events.length;u++)angular.extend(t.events[u],l);n.push(t.events)}}return Array.prototype.concat.apply([],n)},this.changeWatcher=function(n,e){var r,a=function(){for(var r,a,t=angular.isFunction(n)?n():n,o=[],u=0,i=t.length;u<i;u++)a=t[u],r=e(a),l[r]=a,o.push(r);return o},t=function(n,e){var r,a,t=[],l={};for(r=0,a=e.length;r<a;r++)l[e[r]]=!0;for(r=0,a=n.length;r<a;r++)l[n[r]]||t.push(n[r]);return t},l={},o=function(n,a){var o,u,i,c,d={},f=t(a,n);for(o=0,u=f.length;o<u;o++){var s=f[o];i=l[s],delete l[s];var v=e(i);v===s?r.onRemoved(i):(d[v]=s,r.onChanged(i))}var g=t(n,a);for(o=0,u=g.length;o<u;o++)c=g[o],i=l[c],d[c]||r.onAdded(i)};return r={subscribe:function(n,e){n.$watch(a,function(n,r){!(e&&!1===e(n,r))&&o(n,r)},!0)},onAdded:angular.noop,onChanged:angular.noop,onRemoved:angular.noop}},this.getFullCalendarConfig=function(n,e){var r={};return angular.extend(r,e),angular.extend(r,n),angular.forEach(r,function(n,e){"function"==typeof n&&(r[e]=t(r[e]))}),r},this.getLocaleConfig=function(n){if(!n.lang||n.useNgLocale){var r=function(n){var e,r;e=[];for(r in n)e[r]=n[r];return e},a=e.DATETIME_FORMATS;return{monthNames:r(a.MONTH),monthNamesShort:r(a.SHORTMONTH),dayNames:r(a.DAY),dayNamesShort:r(a.SHORTDAY)}}return{}}}]).directive("uiCalendar",["uiCalendarConfig",function(n){return{restrict:"A",scope:{eventSources:"=ngModel",calendarWatchEvent:"&"},controller:"uiCalendarCtrl",link:function(e,r,a,t){function l(){var r,l=a.uiCalendar?e.$parent.$eval(a.uiCalendar):{};r=t.getFullCalendarConfig(l,n);var o=t.getLocaleConfig(r);angular.extend(o,r),f={eventSources:u},angular.extend(f,o),f.calendars=null;var i={};for(var c in f)"eventSources"!==c&&(i[c]=f[c]);return JSON.stringify(i)}var o,u=e.eventSources,i=!1,c=t.changeWatcher(u,t.sourceFingerprint),d=t.changeWatcher(t.allEvents,t.eventFingerprint),f=null;e.destroy=function(){o&&o.fullCalendar&&o.fullCalendar("destroy"),o=a.calendar?n.calendars[a.calendar]=$(r).html(""):$(r).html("")},e.init=function(){o.fullCalendar(f),a.calendar&&(n.calendars[a.calendar]=o)},c.onAdded=function(n){o.fullCalendar("addEventSource",n),i=!0},c.onRemoved=function(n){o.fullCalendar("removeEventSource",n),i=!0},c.onChanged=function(n){o.fullCalendar("refetchEvents"),i=!0},d.onAdded=function(n){o.fullCalendar("renderEvent",n,!!n.stick)},d.onRemoved=function(n){o.fullCalendar("removeEvents",n._id)},d.onChanged=function(n){for(var e=o.fullCalendar("clientEvents",n._id),r=0;r<e.length;r++){var a=e[r];a=angular.extend(a,n),o.fullCalendar("updateEvent",a)}},c.subscribe(e),d.subscribe(e,function(){if(!0===i)return i=!1,!1}),e.$watch(l,function(n,r){e.destroy(),e.init()})}}}]);